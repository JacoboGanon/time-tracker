// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

// NOTE: When using mysql or sqlserver, uncomment the //@db.Text annotations in model Account below
// Further reading:
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectRole {
  owner
  manager
  member
  viewer
}

enum TimeEntrySource {
  manual
  stopwatch
}

model User {
  id                    String                @id
  name                  String //@db.Text
  email                 String
  emailVerified         Boolean               @default(false)
  image                 String? //@db.Text
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @default(now()) @updatedAt
  sessions              Session[]
  accounts              Account[]
  projectMemberships    ProjectMember[]
  timeEntries           TimeEntry[]
  rateCard              RateCard?
  projectRateOverrides  ProjectRateOverride[]
  createdActivityTypes  ActivityType[]        @relation("ActivityTypeCreatedBy")
  generatedReports      Report[]              @relation("ReportGeneratedBy")
  changedTimeEntryAudit TimeEntryAudit[]      @relation("TimeEntryAuditChangedBy")

  @@unique([email])
  @@map("user")
}

model Client {
  id          String      @id @default(cuid())
  name        String
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  projects    Project[]
  timeEntries TimeEntry[]
  reports     Report[]

  @@index([name])
}

model Project {
  id            String                @id @default(cuid())
  clientId      String
  name          String
  code          String?
  description   String?
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  client        Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  members       ProjectMember[]
  timeEntries   TimeEntry[]
  rateOverrides ProjectRateOverride[]
  reports       Report[]

  @@unique([clientId, name])
  @@index([clientId, isActive])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId, role])
}

model ActivityType {
  id                String      @id @default(cuid())
  name              String      @unique
  isBillableDefault Boolean     @default(true)
  createdById       String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  createdBy         User?       @relation("ActivityTypeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  timeEntries       TimeEntry[]
}

model TimeEntry {
  id             String          @id @default(cuid())
  userId         String
  clientId       String
  projectId      String
  activityTypeId String
  source         TimeEntrySource @default(manual)
  startAt        DateTime
  endAt          DateTime
  durationMinutes Int
  description    String
  isBillable     Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  activityType   ActivityType    @relation(fields: [activityTypeId], references: [id], onDelete: Restrict)
  audits         TimeEntryAudit[]

  @@index([userId, startAt, endAt])
  @@index([projectId, startAt])
  @@index([clientId, startAt])
  @@index([activityTypeId, startAt])
}

model RateCard {
  id             String   @id @default(cuid())
  userId         String   @unique
  hourlyRateCents Int
  currency       String   @default("USD")
  effectiveFrom  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProjectRateOverride {
  id             String   @id @default(cuid())
  projectId      String
  userId         String
  hourlyRateCents Int
  currency       String   @default("USD")
  effectiveFrom  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Report {
  id            String           @id @default(cuid())
  clientId      String?
  projectId     String?
  generatedById String
  startDate     DateTime
  endDate       DateTime
  filters       Json
  createdAt     DateTime         @default(now())
  client        Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project       Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  generatedBy   User             @relation("ReportGeneratedBy", fields: [generatedById], references: [id], onDelete: Cascade)
  snapshots     ReportSnapshot[]

  @@index([startDate, endDate])
  @@index([generatedById, createdAt])
}

model ReportSnapshot {
  id        String   @id @default(cuid())
  reportId  String
  summary   Json
  createdAt DateTime @default(now())
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model TimeEntryAudit {
  id            String    @id @default(cuid())
  timeEntryId   String
  changedById   String
  field         String
  previousValue String?
  newValue      String?
  changedAt     DateTime  @default(now())
  timeEntry     TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  changedBy     User      @relation("TimeEntryAuditChangedBy", fields: [changedById], references: [id], onDelete: Cascade)

  @@index([timeEntryId, changedAt])
  @@index([changedById, changedAt])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}
